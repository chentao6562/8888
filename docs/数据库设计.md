# 公司管理系统 - 数据库设计

## 一、ER 关系图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    User     │       │   Project   │       │  Indicator  │
│   (用户)    │───┐   │   (项目)    │───────│   (指标)    │
└─────────────┘   │   └─────────────┘       └─────────────┘
                  │          │
                  │          │
                  │   ┌──────┴──────┐
                  │   │             │
                  ↓   ↓             ↓
            ┌─────────────┐   ┌─────────────┐
            │ProjectMember│   │   Account   │
            │(项目成员)    │   │   (账号)    │
            └─────────────┘   └──────┬──────┘
                                     │
                              ┌──────┴──────┐
                              ↓             ↓
                        ┌─────────────┐ ┌─────────────┐
                        │TrafficData  │ │   Content   │
                        │ (流量数据)  │ │   (作品)    │
                        └─────────────┘ └─────────────┘

┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    Lead     │───────│  LeadLog    │       │  Customer   │
│   (线索)    │       │ (跟进记录)  │       │   (客户)    │
└─────────────┘       └─────────────┘       └─────────────┘
```

---

## 二、数据表设计

### 2.1 用户表 (users)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| username | VARCHAR(50) | 用户名 |
| password | VARCHAR(255) | 密码（加密） |
| name | VARCHAR(50) | 姓名 |
| phone | VARCHAR(20) | 手机号 |
| email | VARCHAR(100) | 邮箱 |
| role | ENUM | 角色：admin/manager/operator/sales/staff |
| avatar | VARCHAR(255) | 头像 URL |
| status | TINYINT | 状态：1启用/0禁用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(50) NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(100),
    role ENUM('admin', 'manager', 'operator', 'sales', 'staff') DEFAULT 'staff',
    avatar VARCHAR(255),
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

### 2.2 项目表 (projects)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 项目名称 |
| description | TEXT | 项目描述/背景 |
| goal | TEXT | 核心目标 |
| status | ENUM | 状态：active/completed/paused |
| start_date | DATE | 开始日期 |
| end_date | DATE | 结束日期 |
| created_by | INT | 创建人 ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE projects (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    goal TEXT,
    status ENUM('active', 'completed', 'paused') DEFAULT 'active',
    start_date DATE,
    end_date DATE,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

---

### 2.3 项目成员表 (project_members)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 项目 ID |
| user_id | INT | 用户 ID |
| role | VARCHAR(50) | 在项目中的角色 |
| joined_at | DATETIME | 加入时间 |

```sql
CREATE TABLE project_members (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    user_id INT NOT NULL,
    role VARCHAR(50),
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY (project_id, user_id)
);
```

---

### 2.4 指标表 (indicators)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 所属项目 |
| name | VARCHAR(100) | 指标名称 |
| description | TEXT | 指标描述 |
| target_value | DECIMAL(15,2) | 目标值 |
| current_value | DECIMAL(15,2) | 当前值 |
| unit | VARCHAR(20) | 单位 |
| priority | ENUM | 优先级：urgent_important/important/urgent/normal |
| assigned_to | INT | 负责人 ID |
| due_date | DATE | 截止日期 |
| status | ENUM | 状态：pending/in_progress/completed |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE indicators (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    target_value DECIMAL(15,2) DEFAULT 0,
    current_value DECIMAL(15,2) DEFAULT 0,
    unit VARCHAR(20),
    priority ENUM('urgent_important', 'important', 'urgent', 'normal') DEFAULT 'normal',
    assigned_to INT,
    due_date DATE,
    status ENUM('pending', 'in_progress', 'completed') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id)
);
```

---

### 2.5 账号表 (accounts)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 所属项目 |
| platform | ENUM | 平台：douyin/kuaishou/xiaohongshu/shipinhao |
| account_name | VARCHAR(100) | 账号名称 |
| account_id | VARCHAR(100) | 平台账号 ID |
| followers | INT | 粉丝数 |
| operator_id | INT | 运营负责人 |
| status | TINYINT | 状态：1启用/0禁用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE accounts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    platform ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao') NOT NULL,
    account_name VARCHAR(100) NOT NULL,
    account_id VARCHAR(100),
    followers INT DEFAULT 0,
    operator_id INT,
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (operator_id) REFERENCES users(id)
);
```

---

### 2.6 流量数据表 (traffic_data)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| account_id | INT | 账号 ID |
| content_title | VARCHAR(255) | 作品标题 |
| publish_date | DATE | 发布日期 |
| views | INT | 播放量/阅读量 |
| likes | INT | 点赞数 |
| comments | INT | 评论数 |
| shares | INT | 分享/转发数 |
| saves | INT | 收藏数 |
| completion_rate | DECIMAL(5,2) | 完播率 (%) |
| import_batch | VARCHAR(50) | 导入批次 |
| created_at | DATETIME | 创建时间 |

```sql
CREATE TABLE traffic_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    account_id INT NOT NULL,
    content_title VARCHAR(255),
    publish_date DATE,
    views INT DEFAULT 0,
    likes INT DEFAULT 0,
    comments INT DEFAULT 0,
    shares INT DEFAULT 0,
    saves INT DEFAULT 0,
    completion_rate DECIMAL(5,2),
    import_batch VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_publish_date (publish_date),
    INDEX idx_account_date (account_id, publish_date)
);
```

---

### 2.7 线索表 (leads)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 所属项目 |
| customer_name | VARCHAR(100) | 客户姓名 |
| phone | VARCHAR(20) | 手机号 |
| wechat | VARCHAR(50) | 微信号 |
| source_platform | ENUM | 来源平台 |
| source_type | ENUM | 来源类型 |
| assigned_to | INT | 负责人 |
| status | ENUM | 状态 |
| amount | DECIMAL(15,2) | 成交金额 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE leads (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    customer_name VARCHAR(100),
    phone VARCHAR(20),
    wechat VARCHAR(50),
    source_platform ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao', 'wechat', 'other') NOT NULL,
    source_type ENUM('private_message', 'to_wechat', 'first_sale', 'repeat_sale') NOT NULL,
    assigned_to INT,
    status ENUM('pending', 'following', 'converted', 'lost', 'hold') DEFAULT 'pending',
    amount DECIMAL(15,2) DEFAULT 0,
    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_assigned (assigned_to)
);
```

---

### 2.8 线索跟进记录表 (lead_logs)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| lead_id | INT | 线索 ID |
| user_id | INT | 操作人 |
| action | VARCHAR(50) | 操作类型 |
| content | TEXT | 跟进内容 |
| created_at | DATETIME | 创建时间 |

```sql
CREATE TABLE lead_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    lead_id INT NOT NULL,
    user_id INT NOT NULL,
    action VARCHAR(50),
    content TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (lead_id) REFERENCES leads(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_lead (lead_id)
);
```

---

### 2.9 数据导入记录表 (import_records)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| type | ENUM | 类型：traffic/lead |
| file_name | VARCHAR(255) | 文件名 |
| batch_no | VARCHAR(50) | 批次号 |
| total_rows | INT | 总行数 |
| success_rows | INT | 成功行数 |
| failed_rows | INT | 失败行数 |
| status | ENUM | 状态 |
| error_log | TEXT | 错误日志 |
| created_by | INT | 操作人 |
| created_at | DATETIME | 创建时间 |

```sql
CREATE TABLE import_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('traffic', 'lead') NOT NULL,
    file_name VARCHAR(255),
    batch_no VARCHAR(50),
    total_rows INT DEFAULT 0,
    success_rows INT DEFAULT 0,
    failed_rows INT DEFAULT 0,
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    error_log TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

---

### 2.10 AI 分析记录表 (ai_analyses)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| type | ENUM | 分析类型 |
| target_type | VARCHAR(50) | 目标类型（project/account/lead） |
| target_id | INT | 目标 ID |
| input_data | JSON | 输入数据 |
| result | TEXT | 分析结果 |
| created_by | INT | 操作人 |
| created_at | DATETIME | 创建时间 |

```sql
CREATE TABLE ai_analyses (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('traffic_diagnosis', 'content_suggestion', 'sales_advice', 'performance', 'project_review') NOT NULL,
    target_type VARCHAR(50),
    target_id INT,
    input_data JSON,
    result TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_target (target_type, target_id)
);
```

---

## 三、完整建表 SQL

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS gongsiguanli_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE gongsiguanli_db;

-- 用户表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(50) NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(100),
    role ENUM('admin', 'manager', 'operator', 'sales', 'staff') DEFAULT 'staff',
    avatar VARCHAR(255),
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 项目表
CREATE TABLE projects (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    goal TEXT,
    status ENUM('active', 'completed', 'paused') DEFAULT 'active',
    start_date DATE,
    end_date DATE,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 项目成员表
CREATE TABLE project_members (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    user_id INT NOT NULL,
    role VARCHAR(50),
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY (project_id, user_id)
);

-- 指标表
CREATE TABLE indicators (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    target_value DECIMAL(15,2) DEFAULT 0,
    current_value DECIMAL(15,2) DEFAULT 0,
    unit VARCHAR(20),
    priority ENUM('urgent_important', 'important', 'urgent', 'normal') DEFAULT 'normal',
    assigned_to INT,
    due_date DATE,
    status ENUM('pending', 'in_progress', 'completed') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id)
);

-- 账号表
CREATE TABLE accounts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    platform ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao') NOT NULL,
    account_name VARCHAR(100) NOT NULL,
    account_id VARCHAR(100),
    followers INT DEFAULT 0,
    operator_id INT,
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (operator_id) REFERENCES users(id)
);

-- 流量数据表
CREATE TABLE traffic_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    account_id INT NOT NULL,
    content_title VARCHAR(255),
    publish_date DATE,
    views INT DEFAULT 0,
    likes INT DEFAULT 0,
    comments INT DEFAULT 0,
    shares INT DEFAULT 0,
    saves INT DEFAULT 0,
    completion_rate DECIMAL(5,2),
    import_batch VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_publish_date (publish_date),
    INDEX idx_account_date (account_id, publish_date)
);

-- 线索表
CREATE TABLE leads (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    customer_name VARCHAR(100),
    phone VARCHAR(20),
    wechat VARCHAR(50),
    source_platform ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao', 'wechat', 'other') NOT NULL,
    source_type ENUM('private_message', 'to_wechat', 'first_sale', 'repeat_sale') NOT NULL,
    assigned_to INT,
    status ENUM('pending', 'following', 'converted', 'lost', 'hold') DEFAULT 'pending',
    amount DECIMAL(15,2) DEFAULT 0,
    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_assigned (assigned_to)
);

-- 线索跟进记录表
CREATE TABLE lead_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    lead_id INT NOT NULL,
    user_id INT NOT NULL,
    action VARCHAR(50),
    content TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (lead_id) REFERENCES leads(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_lead (lead_id)
);

-- 数据导入记录表
CREATE TABLE import_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('traffic', 'lead') NOT NULL,
    file_name VARCHAR(255),
    batch_no VARCHAR(50),
    total_rows INT DEFAULT 0,
    success_rows INT DEFAULT 0,
    failed_rows INT DEFAULT 0,
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    error_log TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- AI 分析记录表
CREATE TABLE ai_analyses (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('traffic_diagnosis', 'content_suggestion', 'sales_advice', 'performance', 'project_review') NOT NULL,
    target_type VARCHAR(50),
    target_id INT,
    input_data JSON,
    result TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_target (target_type, target_id)
);

-- 插入默认管理员账号
INSERT INTO users (username, password, name, role) VALUES
('admin', '$2b$10$XXXX', '管理员', 'admin');
```

---

## 四、新增功能模块数据表

### 4.1 客户表 (customers)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 客户姓名 |
| phone | VARCHAR(20) | 手机号 |
| wechat | VARCHAR(50) | 微信号 |
| email | VARCHAR(100) | 邮箱 |
| company | VARCHAR(200) | 公司名称 |
| address | VARCHAR(500) | 地址 |
| source | ENUM | 来源渠道 |
| level | ENUM | 客户等级：vip/important/normal/potential |
| assigned_to | INT | 负责人 ID |
| total_amount | DECIMAL(15,2) | 累计成交金额 |
| order_count | INT | 成交次数 |
| last_contact_at | DATETIME | 最后联系时间 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.2 客户标签表 (customer_tags)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(50) | 标签名称 |
| color | VARCHAR(20) | 标签颜色 |
| category | VARCHAR(50) | 标签分类（行业、需求、偏好等） |
| description | VARCHAR(200) | 描述 |
| sort_order | INT | 排序 |
| created_at | DATETIME | 创建时间 |

---

### 4.3 客户标签关联表 (customer_tag_relations)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| customer_id | INT | 客户 ID |
| tag_id | INT | 标签 ID |
| created_at | DATETIME | 创建时间 |

---

### 4.4 客户跟进记录表 (customer_follow_logs)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| customer_id | INT | 客户 ID |
| user_id | INT | 操作人 ID |
| type | ENUM | 跟进类型：call/wechat/meeting/email/other |
| content | TEXT | 跟进内容 |
| next_follow_at | DATETIME | 下次跟进时间 |
| created_at | DATETIME | 创建时间 |

---

### 4.5 订单表 (orders)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| order_no | VARCHAR(50) | 订单编号（唯一） |
| project_id | INT | 项目 ID |
| customer_id | INT | 客户 ID |
| lead_id | INT | 线索 ID |
| product_name | VARCHAR(200) | 产品/服务名称 |
| amount | DECIMAL(15,2) | 订单金额 |
| paid_amount | DECIMAL(15,2) | 已回款金额 |
| payment_status | ENUM | 回款状态：unpaid/partial/paid |
| sales_id | INT | 销售人员 ID |
| commission_rate | DECIMAL(5,2) | 提成比例 % |
| commission_amount | DECIMAL(15,2) | 提成金额 |
| signed_at | DATETIME | 签约日期 |
| delivered_at | DATETIME | 交付日期 |
| status | ENUM | 状态：pending/confirmed/processing/delivered/completed/cancelled |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.6 回款记录表 (payments)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| order_id | INT | 订单 ID |
| amount | DECIMAL(15,2) | 回款金额 |
| payment_method | ENUM | 支付方式：transfer/alipay/wechat/cash/other |
| paid_at | DATETIME | 支付时间 |
| remark | VARCHAR(500) | 备注 |
| created_by | INT | 创建人 ID |
| created_at | DATETIME | 创建时间 |

---

### 4.7 支出表 (expenses)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 项目 ID |
| category | ENUM | 分类：ad_cost/platform_fee/labor_cost/equipment/office/travel/marketing/other |
| sub_category | VARCHAR(50) | 子分类 |
| amount | DECIMAL(15,2) | 金额 |
| description | VARCHAR(500) | 描述 |
| expense_date | DATE | 支出日期 |
| attachments | JSON | 附件 URL 列表 |
| applicant_id | INT | 申请人 ID |
| approver_id | INT | 审批人 ID |
| status | ENUM | 状态：pending/approved/rejected/paid |
| approved_at | DATETIME | 审批时间 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.8 预算表 (budgets)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 项目 ID |
| category | ENUM | 预算分类 |
| name | VARCHAR(100) | 预算名称 |
| planned_amount | DECIMAL(15,2) | 计划金额 |
| used_amount | DECIMAL(15,2) | 已使用金额 |
| start_date | DATE | 开始日期 |
| end_date | DATE | 结束日期 |
| alert_rate | DECIMAL(5,2) | 预警百分比 |
| status | ENUM | 状态：active/completed/exceeded/cancelled |
| created_by | INT | 创建人 ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.9 任务表 (tasks)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 项目 ID |
| title | VARCHAR(200) | 任务标题 |
| description | TEXT | 任务描述 |
| priority | ENUM | 优先级：urgent/high/normal/low |
| assignee_id | INT | 执行人 ID |
| assigner_id | INT | 指派人 ID |
| status | ENUM | 状态：pending/in_progress/completed/cancelled |
| due_date | DATETIME | 截止时间 |
| completed_at | DATETIME | 完成时间 |
| parent_id | INT | 父任务 ID（支持子任务） |
| attachments | JSON | 附件 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.10 任务评论表 (task_comments)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| task_id | INT | 任务 ID |
| user_id | INT | 用户 ID |
| content | TEXT | 评论内容 |
| created_at | DATETIME | 创建时间 |

---

### 4.11 内容排期表 (content_schedules)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 项目 ID |
| account_id | INT | 账号 ID |
| title | VARCHAR(200) | 内容标题 |
| content_type | ENUM | 类型：video/image/article/live/short_video |
| description | TEXT | 描述 |
| scheduled_at | DATETIME | 计划发布时间 |
| published_at | DATETIME | 实际发布时间 |
| status | ENUM | 状态：draft/scheduled/published/cancelled |
| assignee_id | INT | 负责人 ID |
| material_ids | JSON | 关联素材 ID 列表 |
| traffic_data_id | INT | 关联流量数据 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.12 素材库表 (materials)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(200) | 素材名称 |
| type | ENUM | 类型：video/image/audio/document/template |
| category | VARCHAR(50) | 素材分类 |
| file_url | VARCHAR(500) | 文件 URL |
| thumbnail_url | VARCHAR(500) | 缩略图 URL |
| file_size | INT | 文件大小（字节） |
| duration | INT | 视频时长（秒） |
| tags | JSON | 标签列表 |
| description | VARCHAR(500) | 描述 |
| usage_count | INT | 使用次数 |
| uploaded_by | INT | 上传人 ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.13 话术模板库 (script_templates)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 模板名称 |
| category | VARCHAR(50) | 分类（开场白、产品介绍、异议处理等） |
| scenario | VARCHAR(100) | 适用场景 |
| content | TEXT | 话术内容 |
| tags | JSON | 标签 |
| usage_count | INT | 使用次数 |
| rating | DECIMAL(3,2) | 平均评分 |
| created_by | INT | 创建人 ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.14 自动化规则表 (automation_rules)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 规则名称 |
| description | VARCHAR(500) | 描述 |
| trigger_type | ENUM | 触发类型：schedule/event/condition |
| trigger_config | JSON | 触发条件配置 |
| action_type | ENUM | 动作类型：notification/task_create/task_assign/report_generate/data_sync/alert |
| action_config | JSON | 执行动作配置 |
| is_enabled | BOOLEAN | 是否启用 |
| priority | INT | 优先级 |
| execution_count | INT | 执行次数 |
| last_executed_at | DATETIME | 最后执行时间 |
| created_by | INT | 创建人 ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 4.15 自动化执行日志表 (automation_logs)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| rule_id | INT | 规则 ID |
| status | ENUM | 执行状态：success/failed/skipped |
| input_data | JSON | 输入数据 |
| output_data | JSON | 输出数据 |
| error_message | TEXT | 错误信息 |
| executed_at | DATETIME | 执行时间 |

---

### 4.16 通知表 (notifications)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| user_id | INT | 用户 ID |
| type | ENUM | 类型：system/task/lead/payment/report/warning/announcement |
| title | VARCHAR(200) | 标题 |
| content | TEXT | 内容 |
| related_type | VARCHAR(50) | 关联对象类型 |
| related_id | INT | 关联对象 ID |
| is_read | BOOLEAN | 是否已读 |
| read_at | DATETIME | 阅读时间 |
| created_at | DATETIME | 创建时间 |

---

## 五、ER 关系图（完整版）

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    User     │       │   Project   │       │  Indicator  │       │   Account   │
│   (用户)    │───┐   │   (项目)    │───────│   (指标)    │       │   (账号)    │
└─────────────┘   │   └──────┬──────┘       └─────────────┘       └──────┬──────┘
      │          │          │                                           │
      │          │   ┌──────┴──────┬──────────┬──────────┐             │
      │          │   │             │          │          │             │
      │          ↓   ↓             ↓          ↓          ↓             ↓
      │    ┌─────────────┐   ┌─────────┐ ┌─────────┐ ┌─────────┐  ┌─────────────┐
      │    │ProjectMember│   │ Order   │ │ Expense │ │  Task   │  │ContentSchedule│
      │    │(项目成员)    │   │ (订单)  │ │ (支出)  │ │ (任务)  │  │ (内容排期)   │
      │    └─────────────┘   └────┬────┘ └─────────┘ └─────────┘  └─────────────┘
      │                          │
      │                          ↓
      │                    ┌─────────────┐
      │                    │   Payment   │
      │                    │  (回款)     │
      │                    └─────────────┘
      │
      ├──────────────────────────────────────────────────────────┐
      │                                                          │
      ↓                                                          ↓
┌─────────────┐       ┌─────────────┐       ┌─────────────┐ ┌─────────────┐
│  Customer   │───────│CustomerTag  │       │   Lead      │ │Notification │
│   (客户)    │       │ (客户标签)  │       │  (线索)     │ │   (通知)    │
└──────┬──────┘       └─────────────┘       └──────┬──────┘ └─────────────┘
       │                                          │
       ↓                                          ↓
┌─────────────┐                            ┌─────────────┐
│CustomerFollow│                           │  LeadLog    │
│ (跟进记录)   │                           │ (跟进记录)  │
└─────────────┘                            └─────────────┘

┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│AutomationRule│─────│AutomationLog│       │  Material   │
│(自动化规则)  │      │ (执行日志)  │       │  (素材)     │
└─────────────┘       └─────────────┘       └─────────────┘

┌─────────────┐       ┌─────────────┐
│ScriptTemplate│      │   Budget    │
│ (话术模板)   │      │   (预算)    │
└─────────────┘       └─────────────┘
```

---

## 六、新增表建表 SQL

```sql
-- 客户表
CREATE TABLE customers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    wechat VARCHAR(50),
    email VARCHAR(100),
    company VARCHAR(200),
    address VARCHAR(500),
    source ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao', 'wechat', 'other'),
    level ENUM('vip', 'important', 'normal', 'potential') DEFAULT 'normal',
    assigned_to INT,
    total_amount DECIMAL(15,2) DEFAULT 0,
    order_count INT DEFAULT 0,
    last_contact_at DATETIME,
    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (assigned_to) REFERENCES users(id),
    INDEX idx_customer_assigned (assigned_to),
    INDEX idx_customer_level (level)
);

-- 客户标签表
CREATE TABLE customer_tags (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    color VARCHAR(20),
    category VARCHAR(50),
    description VARCHAR(200),
    sort_order INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 客户标签关联表
CREATE TABLE customer_tag_relations (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL,
    tag_id INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (tag_id) REFERENCES customer_tags(id),
    UNIQUE KEY (customer_id, tag_id)
);

-- 客户跟进记录表
CREATE TABLE customer_follow_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL,
    user_id INT NOT NULL,
    type ENUM('call', 'wechat', 'meeting', 'email', 'other') DEFAULT 'other',
    content TEXT NOT NULL,
    next_follow_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_follow_customer (customer_id)
);

-- 订单表
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) NOT NULL UNIQUE,
    project_id INT,
    customer_id INT,
    lead_id INT,
    product_name VARCHAR(200) NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    paid_amount DECIMAL(15,2) DEFAULT 0,
    payment_status ENUM('unpaid', 'partial', 'paid') DEFAULT 'unpaid',
    sales_id INT,
    commission_rate DECIMAL(5,2),
    commission_amount DECIMAL(15,2),
    signed_at DATETIME,
    delivered_at DATETIME,
    status ENUM('pending', 'confirmed', 'processing', 'delivered', 'completed', 'cancelled') DEFAULT 'pending',
    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (sales_id) REFERENCES users(id),
    INDEX idx_order_payment_status (payment_status),
    INDEX idx_order_sales (sales_id),
    INDEX idx_order_signed (signed_at)
);

-- 回款记录表
CREATE TABLE payments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    payment_method ENUM('transfer', 'alipay', 'wechat', 'cash', 'other') DEFAULT 'transfer',
    paid_at DATETIME NOT NULL,
    remark VARCHAR(500),
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_payment_order (order_id)
);

-- 支出表
CREATE TABLE expenses (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    category ENUM('ad_cost', 'platform_fee', 'labor_cost', 'equipment', 'office', 'travel', 'marketing', 'other') NOT NULL,
    sub_category VARCHAR(50),
    amount DECIMAL(15,2) NOT NULL,
    description VARCHAR(500) NOT NULL,
    expense_date DATE NOT NULL,
    attachments JSON,
    applicant_id INT,
    approver_id INT,
    status ENUM('pending', 'approved', 'rejected', 'paid') DEFAULT 'pending',
    approved_at DATETIME,
    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (applicant_id) REFERENCES users(id),
    FOREIGN KEY (approver_id) REFERENCES users(id),
    INDEX idx_expense_category (category),
    INDEX idx_expense_date (expense_date)
);

-- 预算表
CREATE TABLE budgets (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    category ENUM('ad_cost', 'platform_fee', 'labor_cost', 'equipment', 'office', 'travel', 'marketing', 'other') NOT NULL,
    name VARCHAR(100) NOT NULL,
    planned_amount DECIMAL(15,2) NOT NULL,
    used_amount DECIMAL(15,2) DEFAULT 0,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    alert_rate DECIMAL(5,2) DEFAULT 80,
    status ENUM('active', 'completed', 'exceeded', 'cancelled') DEFAULT 'active',
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 任务表
CREATE TABLE tasks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    priority ENUM('urgent', 'high', 'normal', 'low') DEFAULT 'normal',
    assignee_id INT,
    assigner_id INT,
    status ENUM('pending', 'in_progress', 'completed', 'cancelled') DEFAULT 'pending',
    due_date DATETIME,
    completed_at DATETIME,
    parent_id INT,
    attachments JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assignee_id) REFERENCES users(id),
    FOREIGN KEY (assigner_id) REFERENCES users(id),
    FOREIGN KEY (parent_id) REFERENCES tasks(id),
    INDEX idx_task_assignee (assignee_id),
    INDEX idx_task_status (status),
    INDEX idx_task_due (due_date)
);

-- 任务评论表
CREATE TABLE task_comments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    task_id INT NOT NULL,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 内容排期表
CREATE TABLE content_schedules (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    account_id INT,
    title VARCHAR(200) NOT NULL,
    content_type ENUM('video', 'image', 'article', 'live', 'short_video') NOT NULL,
    description TEXT,
    scheduled_at DATETIME NOT NULL,
    published_at DATETIME,
    status ENUM('draft', 'scheduled', 'published', 'cancelled') DEFAULT 'draft',
    assignee_id INT,
    material_ids JSON,
    traffic_data_id INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (account_id) REFERENCES accounts(id),
    FOREIGN KEY (assignee_id) REFERENCES users(id),
    INDEX idx_content_scheduled (scheduled_at),
    INDEX idx_content_status (status)
);

-- 素材库表
CREATE TABLE materials (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL,
    type ENUM('video', 'image', 'audio', 'document', 'template') NOT NULL,
    category VARCHAR(50),
    file_url VARCHAR(500) NOT NULL,
    thumbnail_url VARCHAR(500),
    file_size INT,
    duration INT,
    tags JSON,
    description VARCHAR(500),
    usage_count INT DEFAULT 0,
    uploaded_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (uploaded_by) REFERENCES users(id),
    INDEX idx_material_type (type),
    INDEX idx_material_category (category)
);

-- 话术模板库
CREATE TABLE script_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    category VARCHAR(50) NOT NULL,
    scenario VARCHAR(100),
    content TEXT NOT NULL,
    tags JSON,
    usage_count INT DEFAULT 0,
    rating DECIMAL(3,2),
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_script_category (category)
);

-- 自动化规则表
CREATE TABLE automation_rules (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description VARCHAR(500),
    trigger_type ENUM('schedule', 'event', 'condition') NOT NULL,
    trigger_config JSON NOT NULL,
    action_type ENUM('notification', 'task_create', 'task_assign', 'report_generate', 'data_sync', 'alert') NOT NULL,
    action_config JSON NOT NULL,
    is_enabled BOOLEAN DEFAULT TRUE,
    priority INT DEFAULT 0,
    execution_count INT DEFAULT 0,
    last_executed_at DATETIME,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 自动化执行日志表
CREATE TABLE automation_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    rule_id INT NOT NULL,
    status ENUM('success', 'failed', 'skipped') DEFAULT 'success',
    input_data JSON,
    output_data JSON,
    error_message TEXT,
    executed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (rule_id) REFERENCES automation_rules(id),
    INDEX idx_automation_log_rule (rule_id)
);

-- 通知表
CREATE TABLE notifications (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    type ENUM('system', 'task', 'lead', 'payment', 'report', 'warning', 'announcement') NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    related_type VARCHAR(50),
    related_id INT,
    is_read BOOLEAN DEFAULT FALSE,
    read_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_notification_user_read (user_id, is_read),
    INDEX idx_notification_created (created_at)
);
```
