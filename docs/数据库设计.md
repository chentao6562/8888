# 公司管理系统 - 数据库设计

## 一、ER 关系图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    User     │       │   Project   │       │  Indicator  │
│   (用户)    │───┐   │   (项目)    │───────│   (指标)    │
└─────────────┘   │   └─────────────┘       └─────────────┘
                  │          │
                  │          │
                  │   ┌──────┴──────┐
                  │   │             │
                  ↓   ↓             ↓
            ┌─────────────┐   ┌─────────────┐
            │ProjectMember│   │   Account   │
            │(项目成员)    │   │   (账号)    │
            └─────────────┘   └──────┬──────┘
                                     │
                              ┌──────┴──────┐
                              ↓             ↓
                        ┌─────────────┐ ┌─────────────┐
                        │TrafficData  │ │   Content   │
                        │ (流量数据)  │ │   (作品)    │
                        └─────────────┘ └─────────────┘

┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    Lead     │───────│  LeadLog    │       │  Customer   │
│   (线索)    │       │ (跟进记录)  │       │   (客户)    │
└─────────────┘       └─────────────┘       └─────────────┘
```

---

## 二、数据表设计

### 2.1 用户表 (users)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| username | VARCHAR(50) | 用户名 |
| password | VARCHAR(255) | 密码（加密） |
| name | VARCHAR(50) | 姓名 |
| phone | VARCHAR(20) | 手机号 |
| email | VARCHAR(100) | 邮箱 |
| role | ENUM | 角色：admin/manager/operator/sales/staff |
| avatar | VARCHAR(255) | 头像 URL |
| status | TINYINT | 状态：1启用/0禁用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(50) NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(100),
    role ENUM('admin', 'manager', 'operator', 'sales', 'staff') DEFAULT 'staff',
    avatar VARCHAR(255),
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

### 2.2 项目表 (projects)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 项目名称 |
| description | TEXT | 项目描述/背景 |
| goal | TEXT | 核心目标 |
| status | ENUM | 状态：active/completed/paused |
| start_date | DATE | 开始日期 |
| end_date | DATE | 结束日期 |
| created_by | INT | 创建人 ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE projects (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    goal TEXT,
    status ENUM('active', 'completed', 'paused') DEFAULT 'active',
    start_date DATE,
    end_date DATE,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

---

### 2.3 项目成员表 (project_members)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 项目 ID |
| user_id | INT | 用户 ID |
| role | VARCHAR(50) | 在项目中的角色 |
| joined_at | DATETIME | 加入时间 |

```sql
CREATE TABLE project_members (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    user_id INT NOT NULL,
    role VARCHAR(50),
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY (project_id, user_id)
);
```

---

### 2.4 指标表 (indicators)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 所属项目 |
| name | VARCHAR(100) | 指标名称 |
| description | TEXT | 指标描述 |
| target_value | DECIMAL(15,2) | 目标值 |
| current_value | DECIMAL(15,2) | 当前值 |
| unit | VARCHAR(20) | 单位 |
| priority | ENUM | 优先级：urgent_important/important/urgent/normal |
| assigned_to | INT | 负责人 ID |
| due_date | DATE | 截止日期 |
| status | ENUM | 状态：pending/in_progress/completed |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE indicators (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    target_value DECIMAL(15,2) DEFAULT 0,
    current_value DECIMAL(15,2) DEFAULT 0,
    unit VARCHAR(20),
    priority ENUM('urgent_important', 'important', 'urgent', 'normal') DEFAULT 'normal',
    assigned_to INT,
    due_date DATE,
    status ENUM('pending', 'in_progress', 'completed') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id)
);
```

---

### 2.5 账号表 (accounts)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 所属项目 |
| platform | ENUM | 平台：douyin/kuaishou/xiaohongshu/shipinhao |
| account_name | VARCHAR(100) | 账号名称 |
| account_id | VARCHAR(100) | 平台账号 ID |
| followers | INT | 粉丝数 |
| operator_id | INT | 运营负责人 |
| status | TINYINT | 状态：1启用/0禁用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE accounts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    platform ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao') NOT NULL,
    account_name VARCHAR(100) NOT NULL,
    account_id VARCHAR(100),
    followers INT DEFAULT 0,
    operator_id INT,
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (operator_id) REFERENCES users(id)
);
```

---

### 2.6 流量数据表 (traffic_data)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| account_id | INT | 账号 ID |
| content_title | VARCHAR(255) | 作品标题 |
| publish_date | DATE | 发布日期 |
| views | INT | 播放量/阅读量 |
| likes | INT | 点赞数 |
| comments | INT | 评论数 |
| shares | INT | 分享/转发数 |
| saves | INT | 收藏数 |
| completion_rate | DECIMAL(5,2) | 完播率 (%) |
| import_batch | VARCHAR(50) | 导入批次 |
| created_at | DATETIME | 创建时间 |

```sql
CREATE TABLE traffic_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    account_id INT NOT NULL,
    content_title VARCHAR(255),
    publish_date DATE,
    views INT DEFAULT 0,
    likes INT DEFAULT 0,
    comments INT DEFAULT 0,
    shares INT DEFAULT 0,
    saves INT DEFAULT 0,
    completion_rate DECIMAL(5,2),
    import_batch VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_publish_date (publish_date),
    INDEX idx_account_date (account_id, publish_date)
);
```

---

### 2.7 线索表 (leads)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| project_id | INT | 所属项目 |
| customer_name | VARCHAR(100) | 客户姓名 |
| phone | VARCHAR(20) | 手机号 |
| wechat | VARCHAR(50) | 微信号 |
| source_platform | ENUM | 来源平台 |
| source_type | ENUM | 来源类型 |
| assigned_to | INT | 负责人 |
| status | ENUM | 状态 |
| amount | DECIMAL(15,2) | 成交金额 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

```sql
CREATE TABLE leads (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    customer_name VARCHAR(100),
    phone VARCHAR(20),
    wechat VARCHAR(50),
    source_platform ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao', 'wechat', 'other') NOT NULL,
    source_type ENUM('private_message', 'to_wechat', 'first_sale', 'repeat_sale') NOT NULL,
    assigned_to INT,
    status ENUM('pending', 'following', 'converted', 'lost', 'hold') DEFAULT 'pending',
    amount DECIMAL(15,2) DEFAULT 0,
    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_assigned (assigned_to)
);
```

---

### 2.8 线索跟进记录表 (lead_logs)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| lead_id | INT | 线索 ID |
| user_id | INT | 操作人 |
| action | VARCHAR(50) | 操作类型 |
| content | TEXT | 跟进内容 |
| created_at | DATETIME | 创建时间 |

```sql
CREATE TABLE lead_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    lead_id INT NOT NULL,
    user_id INT NOT NULL,
    action VARCHAR(50),
    content TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (lead_id) REFERENCES leads(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_lead (lead_id)
);
```

---

### 2.9 数据导入记录表 (import_records)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| type | ENUM | 类型：traffic/lead |
| file_name | VARCHAR(255) | 文件名 |
| batch_no | VARCHAR(50) | 批次号 |
| total_rows | INT | 总行数 |
| success_rows | INT | 成功行数 |
| failed_rows | INT | 失败行数 |
| status | ENUM | 状态 |
| error_log | TEXT | 错误日志 |
| created_by | INT | 操作人 |
| created_at | DATETIME | 创建时间 |

```sql
CREATE TABLE import_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('traffic', 'lead') NOT NULL,
    file_name VARCHAR(255),
    batch_no VARCHAR(50),
    total_rows INT DEFAULT 0,
    success_rows INT DEFAULT 0,
    failed_rows INT DEFAULT 0,
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    error_log TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

---

### 2.10 AI 分析记录表 (ai_analyses)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| type | ENUM | 分析类型 |
| target_type | VARCHAR(50) | 目标类型（project/account/lead） |
| target_id | INT | 目标 ID |
| input_data | JSON | 输入数据 |
| result | TEXT | 分析结果 |
| created_by | INT | 操作人 |
| created_at | DATETIME | 创建时间 |

```sql
CREATE TABLE ai_analyses (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('traffic_diagnosis', 'content_suggestion', 'sales_advice', 'performance', 'project_review') NOT NULL,
    target_type VARCHAR(50),
    target_id INT,
    input_data JSON,
    result TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_target (target_type, target_id)
);
```

---

## 三、完整建表 SQL

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS gongsiguanli_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE gongsiguanli_db;

-- 用户表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(50) NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(100),
    role ENUM('admin', 'manager', 'operator', 'sales', 'staff') DEFAULT 'staff',
    avatar VARCHAR(255),
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 项目表
CREATE TABLE projects (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    goal TEXT,
    status ENUM('active', 'completed', 'paused') DEFAULT 'active',
    start_date DATE,
    end_date DATE,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 项目成员表
CREATE TABLE project_members (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    user_id INT NOT NULL,
    role VARCHAR(50),
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY (project_id, user_id)
);

-- 指标表
CREATE TABLE indicators (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    target_value DECIMAL(15,2) DEFAULT 0,
    current_value DECIMAL(15,2) DEFAULT 0,
    unit VARCHAR(20),
    priority ENUM('urgent_important', 'important', 'urgent', 'normal') DEFAULT 'normal',
    assigned_to INT,
    due_date DATE,
    status ENUM('pending', 'in_progress', 'completed') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id)
);

-- 账号表
CREATE TABLE accounts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    platform ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao') NOT NULL,
    account_name VARCHAR(100) NOT NULL,
    account_id VARCHAR(100),
    followers INT DEFAULT 0,
    operator_id INT,
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (operator_id) REFERENCES users(id)
);

-- 流量数据表
CREATE TABLE traffic_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    account_id INT NOT NULL,
    content_title VARCHAR(255),
    publish_date DATE,
    views INT DEFAULT 0,
    likes INT DEFAULT 0,
    comments INT DEFAULT 0,
    shares INT DEFAULT 0,
    saves INT DEFAULT 0,
    completion_rate DECIMAL(5,2),
    import_batch VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_publish_date (publish_date),
    INDEX idx_account_date (account_id, publish_date)
);

-- 线索表
CREATE TABLE leads (
    id INT PRIMARY KEY AUTO_INCREMENT,
    project_id INT,
    customer_name VARCHAR(100),
    phone VARCHAR(20),
    wechat VARCHAR(50),
    source_platform ENUM('douyin', 'kuaishou', 'xiaohongshu', 'shipinhao', 'wechat', 'other') NOT NULL,
    source_type ENUM('private_message', 'to_wechat', 'first_sale', 'repeat_sale') NOT NULL,
    assigned_to INT,
    status ENUM('pending', 'following', 'converted', 'lost', 'hold') DEFAULT 'pending',
    amount DECIMAL(15,2) DEFAULT 0,
    remark TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assigned_to) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_assigned (assigned_to)
);

-- 线索跟进记录表
CREATE TABLE lead_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    lead_id INT NOT NULL,
    user_id INT NOT NULL,
    action VARCHAR(50),
    content TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (lead_id) REFERENCES leads(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_lead (lead_id)
);

-- 数据导入记录表
CREATE TABLE import_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('traffic', 'lead') NOT NULL,
    file_name VARCHAR(255),
    batch_no VARCHAR(50),
    total_rows INT DEFAULT 0,
    success_rows INT DEFAULT 0,
    failed_rows INT DEFAULT 0,
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    error_log TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- AI 分析记录表
CREATE TABLE ai_analyses (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('traffic_diagnosis', 'content_suggestion', 'sales_advice', 'performance', 'project_review') NOT NULL,
    target_type VARCHAR(50),
    target_id INT,
    input_data JSON,
    result TEXT,
    created_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_target (target_type, target_id)
);

-- 插入默认管理员账号
INSERT INTO users (username, password, name, role) VALUES
('admin', '$2b$10$XXXX', '管理员', 'admin');
```
