// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(50)
  password  String   @db.VarChar(255)
  name      String   @db.VarChar(50)
  phone     String?  @db.VarChar(20)
  email     String?  @db.VarChar(100)
  role      UserRole @default(staff)
  avatar    String?  @db.VarChar(255)
  status    Int      @default(1) @db.TinyInt
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联关系
  createdProjects  Project[]       @relation("ProjectCreator")
  projectMembers   ProjectMember[]
  assignedIndicators Indicator[]   @relation("IndicatorAssignee")
  operatedAccounts Account[]       @relation("AccountOperator")
  assignedLeads    Lead[]          @relation("LeadAssignee")
  leadLogs         LeadLog[]
  importRecords    ImportRecord[]
  aiAnalyses       AiAnalysis[]
  dailyReports     DailyReport[]
  weeklyReports    WeeklyReport[]
  monthlyReports   MonthlyReport[]
  feedbacks        Feedback[]
  projectComments  ProjectComment[]

  // 新增关联关系
  assignedCustomers   Customer[]         @relation("CustomerAssignee")
  customerFollowLogs  CustomerFollowLog[] @relation("CustomerFollower")
  salesOrders         Order[]            @relation("OrderSales")
  createdPayments     Payment[]          @relation("PaymentCreator")
  appliedExpenses     Expense[]          @relation("ExpenseApplicant")
  approvedExpenses    Expense[]          @relation("ExpenseApprover")
  createdBudgets      Budget[]           @relation("BudgetCreator")
  assignedTasks       Task[]             @relation("TaskAssignee")
  assignerTasks       Task[]             @relation("TaskAssigner")
  taskComments        TaskComment[]      @relation("TaskCommenter")
  assignedContents    ContentSchedule[]  @relation("ContentAssignee")
  uploadedMaterials   Material[]         @relation("MaterialUploader")
  createdScripts      ScriptTemplate[]   @relation("ScriptCreator")
  createdAutomations  AutomationRule[]   @relation("AutomationCreator")
  notifications       Notification[]     @relation("NotificationReceiver")

  @@map("users")
}

enum UserRole {
  admin
  manager
  operator
  sales
  staff
}

// 项目表
model Project {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(100)
  description String?       @db.Text
  goal        String?       @db.Text
  status      ProjectStatus @default(active)
  startDate   DateTime?     @map("start_date") @db.Date
  endDate     DateTime?     @map("end_date") @db.Date
  templateId  Int?          @map("template_id")
  createdBy   Int?          @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // 关联关系
  creator     User?           @relation("ProjectCreator", fields: [createdBy], references: [id])
  template    ProjectTemplate? @relation(fields: [templateId], references: [id])
  members     ProjectMember[]
  indicators  Indicator[]
  accounts    Account[]
  leads       Lead[]
  stages      ProjectStage[]
  warnings    ProjectWarning[]
  comments    ProjectComment[]

  // 新增关联关系
  orders           Order[]
  expenses         Expense[]
  budgets          Budget[]
  tasks            Task[]
  contentSchedules ContentSchedule[]

  @@map("projects")
}

enum ProjectStatus {
  active
  completed
  paused
}

// 项目模板表
model ProjectTemplate {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  stages      Json?    // 阶段配置 JSON
  indicators  Json?    // 默认指标配置 JSON
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  projects    Project[]

  @@map("project_templates")
}

// 项目阶段表
model ProjectStage {
  id          Int         @id @default(autoincrement())
  projectId   Int         @map("project_id")
  name        String      @db.VarChar(100)
  description String?     @db.Text
  sortOrder   Int         @default(0) @map("sort_order")
  status      StageStatus @default(pending)
  startDate   DateTime?   @map("start_date") @db.Date
  endDate     DateTime?   @map("end_date") @db.Date
  dueDate     DateTime?   @map("due_date") @db.Date
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  project     Project     @relation(fields: [projectId], references: [id])

  @@map("project_stages")
}

enum StageStatus {
  pending
  in_progress
  completed
  delayed
}

// 项目成员表
model ProjectMember {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  userId    Int      @map("user_id")
  role      String?  @db.VarChar(50)
  joinedAt  DateTime @default(now()) @map("joined_at")

  project   Project  @relation(fields: [projectId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@map("project_members")
}

// 指标表
model Indicator {
  id           Int              @id @default(autoincrement())
  projectId    Int              @map("project_id")
  name         String           @db.VarChar(100)
  description  String?          @db.Text
  targetValue  Decimal          @default(0) @map("target_value") @db.Decimal(15, 2)
  currentValue Decimal          @default(0) @map("current_value") @db.Decimal(15, 2)
  unit         String?          @db.VarChar(20)
  priority     IndicatorPriority @default(normal)
  assignedTo   Int?             @map("assigned_to")
  dueDate      DateTime?        @map("due_date") @db.Date
  status       IndicatorStatus  @default(pending)
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  project      Project          @relation(fields: [projectId], references: [id])
  assignee     User?            @relation("IndicatorAssignee", fields: [assignedTo], references: [id])

  @@map("indicators")
}

enum IndicatorPriority {
  urgent_important
  important
  urgent
  normal
}

enum IndicatorStatus {
  pending
  in_progress
  completed
}

// 账号表
model Account {
  id          Int          @id @default(autoincrement())
  projectId   Int?         @map("project_id")
  platform    Platform
  accountName String       @map("account_name") @db.VarChar(100)
  accountId   String?      @map("account_id") @db.VarChar(100)
  followers   Int          @default(0)
  operatorId  Int?         @map("operator_id")
  status      Int          @default(1) @db.TinyInt
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  project     Project?     @relation(fields: [projectId], references: [id])
  operator    User?        @relation("AccountOperator", fields: [operatorId], references: [id])
  trafficData TrafficData[]
  contentSchedules ContentSchedule[]

  @@map("accounts")
}

enum Platform {
  douyin
  kuaishou
  xiaohongshu
  shipinhao
}

// 流量数据表
model TrafficData {
  id             Int      @id @default(autoincrement())
  accountId      Int      @map("account_id")
  contentTitle   String?  @map("content_title") @db.VarChar(255)
  publishDate    DateTime? @map("publish_date") @db.Date
  views          Int      @default(0)
  likes          Int      @default(0)
  comments       Int      @default(0)
  shares         Int      @default(0)
  saves          Int      @default(0)
  completionRate Decimal? @map("completion_rate") @db.Decimal(5, 2)
  importBatch    String?  @map("import_batch") @db.VarChar(50)
  createdAt      DateTime @default(now()) @map("created_at")

  account        Account  @relation(fields: [accountId], references: [id])

  @@index([publishDate], name: "idx_publish_date")
  @@index([accountId, publishDate], name: "idx_account_date")
  @@map("traffic_data")
}

// 线索表
model Lead {
  id             Int            @id @default(autoincrement())
  projectId      Int?           @map("project_id")
  customerName   String?        @map("customer_name") @db.VarChar(100)
  phone          String?        @db.VarChar(20)
  wechat         String?        @db.VarChar(50)
  sourcePlatform SourcePlatform @map("source_platform")
  sourceType     SourceType     @map("source_type")
  assignedTo     Int?           @map("assigned_to")
  status         LeadStatus     @default(pending)
  amount         Decimal        @default(0) @db.Decimal(15, 2)
  remark         String?        @db.Text
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  project        Project?       @relation(fields: [projectId], references: [id])
  assignee       User?          @relation("LeadAssignee", fields: [assignedTo], references: [id])
  logs           LeadLog[]

  @@index([status], name: "idx_status")
  @@index([assignedTo], name: "idx_assigned")
  @@map("leads")
}

enum SourcePlatform {
  douyin
  kuaishou
  xiaohongshu
  shipinhao
  wechat
  other
}

enum SourceType {
  private_message
  to_wechat
  first_sale
  repeat_sale
}

enum LeadStatus {
  pending
  following
  converted
  lost
  hold
}

// 线索跟进记录表
model LeadLog {
  id        Int      @id @default(autoincrement())
  leadId    Int      @map("lead_id")
  userId    Int      @map("user_id")
  action    String?  @db.VarChar(50)
  content   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  lead      Lead     @relation(fields: [leadId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([leadId], name: "idx_lead")
  @@map("lead_logs")
}

// 数据导入记录表
model ImportRecord {
  id          Int          @id @default(autoincrement())
  type        ImportType
  fileName    String?      @map("file_name") @db.VarChar(255)
  batchNo     String?      @map("batch_no") @db.VarChar(50)
  totalRows   Int          @default(0) @map("total_rows")
  successRows Int          @default(0) @map("success_rows")
  failedRows  Int          @default(0) @map("failed_rows")
  status      ImportStatus @default(pending)
  errorLog    String?      @map("error_log") @db.Text
  createdBy   Int?         @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")

  creator     User?        @relation(fields: [createdBy], references: [id])

  @@map("import_records")
}

enum ImportType {
  traffic
  lead
}

enum ImportStatus {
  pending
  processing
  completed
  failed
}

// AI 分析记录表
model AiAnalysis {
  id         Int          @id @default(autoincrement())
  type       AnalysisType
  targetType String?      @map("target_type") @db.VarChar(50)
  targetId   Int?         @map("target_id")
  inputData  Json?        @map("input_data")
  result     String?      @db.Text
  createdBy  Int?         @map("created_by")
  createdAt  DateTime     @default(now()) @map("created_at")

  creator    User?        @relation(fields: [createdBy], references: [id])

  @@index([targetType, targetId], name: "idx_target")
  @@map("ai_analyses")
}

enum AnalysisType {
  traffic_diagnosis
  content_suggestion
  sales_advice
  performance
  project_review
  leader_report
}

// 项目预警表
model ProjectWarning {
  id          Int           @id @default(autoincrement())
  projectId   Int           @map("project_id")
  type        WarningType
  level       WarningLevel
  title       String        @db.VarChar(200)
  description String?       @db.Text
  isResolved  Boolean       @default(false) @map("is_resolved")
  resolvedAt  DateTime?     @map("resolved_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  project     Project       @relation(fields: [projectId], references: [id])

  @@map("project_warnings")
}

enum WarningType {
  deadline
  indicator
  stage
}

enum WarningLevel {
  yellow
  red
  urgent
}

// 项目评论/反馈表
model ProjectComment {
  id          Int      @id @default(autoincrement())
  projectId   Int      @map("project_id")
  userId      Int?     @map("user_id")
  content     String   @db.Text
  isAnonymous Boolean  @default(false) @map("is_anonymous")
  createdAt   DateTime @default(now()) @map("created_at")

  project     Project  @relation(fields: [projectId], references: [id])
  user        User?    @relation(fields: [userId], references: [id])

  @@map("project_comments")
}

// 匿名反馈表
model Feedback {
  id          Int            @id @default(autoincrement())
  userId      Int?           @map("user_id")
  category    FeedbackCategory
  title       String         @db.VarChar(200)
  content     String         @db.Text
  isAnonymous Boolean        @default(true) @map("is_anonymous")
  status      FeedbackStatus @default(pending)
  reply       String?        @db.Text
  repliedAt   DateTime?      @map("replied_at")
  createdAt   DateTime       @default(now()) @map("created_at")

  user        User?          @relation(fields: [userId], references: [id])

  @@map("feedbacks")
}

enum FeedbackCategory {
  suggestion
  complaint
  question
  other
}

enum FeedbackStatus {
  pending
  processing
  resolved
  closed
}

// 日报表
model DailyReport {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  reportDate  DateTime @map("report_date") @db.Date
  todayWork   String   @map("today_work") @db.Text
  tomorrowPlan String? @map("tomorrow_plan") @db.Text
  problems    String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, reportDate])
  @@map("daily_reports")
}

// 周报表
model WeeklyReport {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  weekStart   DateTime @map("week_start") @db.Date
  weekEnd     DateTime @map("week_end") @db.Date
  summary     String   @db.Text
  achievements String? @db.Text
  nextWeekPlan String? @map("next_week_plan") @db.Text
  problems    String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, weekStart])
  @@map("weekly_reports")
}

// 月报表
model MonthlyReport {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  reportMonth   DateTime @map("report_month") @db.Date
  summary       String   @db.Text
  achievements  String?  @db.Text
  kpiCompletion Json?    @map("kpi_completion")
  nextMonthPlan String?  @map("next_month_plan") @db.Text
  problems      String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user          User     @relation(fields: [userId], references: [id])

  @@unique([userId, reportMonth])
  @@map("monthly_reports")
}

// 企业文化-公告表
model Announcement {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(200)
  content     String   @db.Text
  isTop       Boolean  @default(false) @map("is_top")
  publishedAt DateTime @default(now()) @map("published_at")
  expiredAt   DateTime? @map("expired_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("announcements")
}

// 企业文化-荣誉墙
model Honor {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(200)
  description String?  @db.Text
  imageUrl    String?  @map("image_url") @db.VarChar(500)
  honorDate   DateTime @map("honor_date") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("honors")
}

// 官网内容管理-Banner
model WebsiteBanner {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(200)
  imageUrl    String   @map("image_url") @db.VarChar(500)
  linkUrl     String?  @map("link_url") @db.VarChar(500)
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("website_banners")
}

// 官网内容管理-案例
model WebsiteCase {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(200)
  description String?  @db.Text
  imageUrl    String?  @map("image_url") @db.VarChar(500)
  content     String?  @db.Text
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("website_cases")
}

// 官网内容管理-公司信息
model WebsiteInfo {
  id          Int      @id @default(autoincrement())
  key         String   @unique @db.VarChar(50)
  value       String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("website_info")
}

// ==================== 新增功能模块 ====================

// 客户表
model Customer {
  id             Int              @id @default(autoincrement())
  name           String           @db.VarChar(100)
  phone          String?          @db.VarChar(20)
  wechat         String?          @db.VarChar(50)
  email          String?          @db.VarChar(100)
  company        String?          @db.VarChar(200)
  address        String?          @db.VarChar(500)
  source         SourcePlatform?  // 来源渠道
  level          CustomerLevel    @default(normal) // 客户等级
  assignedTo     Int?             @map("assigned_to")
  totalAmount    Decimal          @default(0) @map("total_amount") @db.Decimal(15, 2) // 累计成交金额
  orderCount     Int              @default(0) @map("order_count") // 成交次数
  lastContactAt  DateTime?        @map("last_contact_at") // 最后联系时间
  remark         String?          @db.Text
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  assignee       User?            @relation("CustomerAssignee", fields: [assignedTo], references: [id])
  tags           CustomerTagRelation[]
  orders         Order[]
  followLogs     CustomerFollowLog[]

  @@index([assignedTo], name: "idx_customer_assigned")
  @@index([level], name: "idx_customer_level")
  @@map("customers")
}

enum CustomerLevel {
  vip        // VIP客户
  important  // 重要客户
  normal     // 普通客户
  potential  // 潜在客户
}

// 客户标签表
model CustomerTag {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(50)
  color       String?  @db.VarChar(20) // 标签颜色
  category    String?  @db.VarChar(50) // 标签分类（行业、需求、偏好等）
  description String?  @db.VarChar(200)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  customers   CustomerTagRelation[]

  @@map("customer_tags")
}

// 客户标签关联表
model CustomerTagRelation {
  id         Int      @id @default(autoincrement())
  customerId Int      @map("customer_id")
  tagId      Int      @map("tag_id")
  createdAt  DateTime @default(now()) @map("created_at")

  customer   Customer    @relation(fields: [customerId], references: [id])
  tag        CustomerTag @relation(fields: [tagId], references: [id])

  @@unique([customerId, tagId])
  @@map("customer_tag_relations")
}

// 客户跟进记录表
model CustomerFollowLog {
  id         Int      @id @default(autoincrement())
  customerId Int      @map("customer_id")
  userId     Int      @map("user_id")
  type       FollowType @default(other)
  content    String   @db.Text
  nextFollowAt DateTime? @map("next_follow_at")
  createdAt  DateTime @default(now()) @map("created_at")

  customer   Customer @relation(fields: [customerId], references: [id])
  user       User     @relation("CustomerFollower", fields: [userId], references: [id])

  @@index([customerId], name: "idx_follow_customer")
  @@map("customer_follow_logs")
}

enum FollowType {
  call      // 电话
  wechat    // 微信
  meeting   // 面谈
  email     // 邮件
  other     // 其他
}

// 订单表（收入管理）
model Order {
  id             Int           @id @default(autoincrement())
  orderNo        String        @unique @map("order_no") @db.VarChar(50) // 订单编号
  projectId      Int?          @map("project_id")
  customerId     Int?          @map("customer_id")
  leadId         Int?          @map("lead_id") // 关联线索
  productName    String        @map("product_name") @db.VarChar(200) // 产品/服务名称
  amount         Decimal       @db.Decimal(15, 2) // 订单金额
  paidAmount     Decimal       @default(0) @map("paid_amount") @db.Decimal(15, 2) // 已回款金额
  paymentStatus  PaymentStatus @default(unpaid) @map("payment_status") // 回款状态
  salesId        Int?          @map("sales_id") // 销售人员
  commissionRate Decimal?      @map("commission_rate") @db.Decimal(5, 2) // 提成比例 %
  commissionAmount Decimal?    @map("commission_amount") @db.Decimal(15, 2) // 提成金额
  signedAt       DateTime?     @map("signed_at") // 签约日期
  deliveredAt    DateTime?     @map("delivered_at") // 交付日期
  status         OrderStatus   @default(pending)
  remark         String?       @db.Text
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  project        Project?      @relation(fields: [projectId], references: [id])
  customer       Customer?     @relation(fields: [customerId], references: [id])
  sales          User?         @relation("OrderSales", fields: [salesId], references: [id])
  payments       Payment[]

  @@index([paymentStatus], name: "idx_order_payment_status")
  @@index([salesId], name: "idx_order_sales")
  @@index([signedAt], name: "idx_order_signed")
  @@map("orders")
}

enum PaymentStatus {
  unpaid      // 未回款
  partial     // 部分回款
  paid        // 已回款
}

enum OrderStatus {
  pending     // 待处理
  confirmed   // 已确认
  processing  // 进行中
  delivered   // 已交付
  completed   // 已完成
  cancelled   // 已取消
}

// 回款记录表
model Payment {
  id          Int           @id @default(autoincrement())
  orderId     Int           @map("order_id")
  amount      Decimal       @db.Decimal(15, 2)
  paymentMethod PaymentMethod @default(transfer) @map("payment_method")
  paidAt      DateTime      @map("paid_at")
  remark      String?       @db.VarChar(500)
  createdBy   Int?          @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")

  order       Order         @relation(fields: [orderId], references: [id])
  creator     User?         @relation("PaymentCreator", fields: [createdBy], references: [id])

  @@index([orderId], name: "idx_payment_order")
  @@map("payments")
}

enum PaymentMethod {
  transfer    // 银行转账
  alipay      // 支付宝
  wechat      // 微信
  cash        // 现金
  other       // 其他
}

// 支出表
model Expense {
  id          Int           @id @default(autoincrement())
  projectId   Int?          @map("project_id")
  category    ExpenseCategory
  subCategory String?       @map("sub_category") @db.VarChar(50)
  amount      Decimal       @db.Decimal(15, 2)
  description String        @db.VarChar(500)
  expenseDate DateTime      @map("expense_date") @db.Date
  attachments Json?         // 附件URL列表
  applicantId Int?          @map("applicant_id") // 申请人
  approverId  Int?          @map("approver_id")  // 审批人
  status      ExpenseStatus @default(pending)
  approvedAt  DateTime?     @map("approved_at")
  remark      String?       @db.Text
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  project     Project?      @relation(fields: [projectId], references: [id])
  applicant   User?         @relation("ExpenseApplicant", fields: [applicantId], references: [id])
  approver    User?         @relation("ExpenseApprover", fields: [approverId], references: [id])

  @@index([category], name: "idx_expense_category")
  @@index([expenseDate], name: "idx_expense_date")
  @@map("expenses")
}

enum ExpenseCategory {
  ad_cost         // 广告投放
  platform_fee    // 平台费用
  labor_cost      // 人工成本
  equipment       // 设备采购
  office          // 办公费用
  travel          // 差旅费用
  marketing       // 市场推广
  other           // 其他
}

enum ExpenseStatus {
  pending    // 待审批
  approved   // 已批准
  rejected   // 已拒绝
  paid       // 已支付
}

// 预算表
model Budget {
  id          Int           @id @default(autoincrement())
  projectId   Int?          @map("project_id")
  category    ExpenseCategory
  name        String        @db.VarChar(100)
  plannedAmount Decimal     @map("planned_amount") @db.Decimal(15, 2) // 计划金额
  usedAmount  Decimal       @default(0) @map("used_amount") @db.Decimal(15, 2) // 已使用金额
  startDate   DateTime      @map("start_date") @db.Date
  endDate     DateTime      @map("end_date") @db.Date
  alertRate   Decimal       @default(80) @map("alert_rate") @db.Decimal(5, 2) // 预警百分比
  status      BudgetStatus  @default(active)
  createdBy   Int?          @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  project     Project?      @relation(fields: [projectId], references: [id])
  creator     User?         @relation("BudgetCreator", fields: [createdBy], references: [id])

  @@map("budgets")
}

enum BudgetStatus {
  active     // 进行中
  completed  // 已完成
  exceeded   // 已超支
  cancelled  // 已取消
}

// 任务表
model Task {
  id          Int        @id @default(autoincrement())
  projectId   Int?       @map("project_id")
  title       String     @db.VarChar(200)
  description String?    @db.Text
  priority    TaskPriority @default(normal)
  assigneeId  Int?       @map("assignee_id") // 执行人
  assignerId  Int?       @map("assigner_id") // 指派人
  status      TaskStatus @default(pending)
  dueDate     DateTime?  @map("due_date")
  completedAt DateTime?  @map("completed_at")
  parentId    Int?       @map("parent_id") // 父任务ID，支持子任务
  attachments Json?      // 附件
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  project     Project?   @relation(fields: [projectId], references: [id])
  assignee    User?      @relation("TaskAssignee", fields: [assigneeId], references: [id])
  assigner    User?      @relation("TaskAssigner", fields: [assignerId], references: [id])
  parent      Task?      @relation("SubTasks", fields: [parentId], references: [id])
  subTasks    Task[]     @relation("SubTasks")
  comments    TaskComment[]

  @@index([assigneeId], name: "idx_task_assignee")
  @@index([status], name: "idx_task_status")
  @@index([dueDate], name: "idx_task_due")
  @@map("tasks")
}

enum TaskPriority {
  urgent    // 紧急
  high      // 高
  normal    // 普通
  low       // 低
}

enum TaskStatus {
  pending      // 待处理
  in_progress  // 进行中
  completed    // 已完成
  cancelled    // 已取消
}

// 任务评论表
model TaskComment {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  userId    Int      @map("user_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  task      Task     @relation(fields: [taskId], references: [id])
  user      User     @relation("TaskCommenter", fields: [userId], references: [id])

  @@map("task_comments")
}

// 内容排期表
model ContentSchedule {
  id          Int               @id @default(autoincrement())
  projectId   Int?              @map("project_id")
  accountId   Int?              @map("account_id")
  title       String            @db.VarChar(200)
  contentType ContentType       @map("content_type")
  description String?           @db.Text
  scheduledAt DateTime          @map("scheduled_at") // 计划发布时间
  publishedAt DateTime?         @map("published_at") // 实际发布时间
  status      ContentStatus     @default(draft)
  assigneeId  Int?              @map("assignee_id")
  materialIds Json?             @map("material_ids") // 关联素材ID列表
  trafficDataId Int?            @map("traffic_data_id") // 关联流量数据
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  project     Project?          @relation(fields: [projectId], references: [id])
  account     Account?          @relation(fields: [accountId], references: [id])
  assignee    User?             @relation("ContentAssignee", fields: [assigneeId], references: [id])

  @@index([scheduledAt], name: "idx_content_scheduled")
  @@index([status], name: "idx_content_status")
  @@map("content_schedules")
}

enum ContentType {
  video       // 视频
  image       // 图文
  article     // 文章
  live        // 直播
  short_video // 短视频
}

enum ContentStatus {
  draft       // 草稿
  scheduled   // 已排期
  published   // 已发布
  cancelled   // 已取消
}

// 素材库表
model Material {
  id          Int            @id @default(autoincrement())
  name        String         @db.VarChar(200)
  type        MaterialType
  category    String?        @db.VarChar(50) // 素材分类
  fileUrl     String         @map("file_url") @db.VarChar(500)
  thumbnailUrl String?       @map("thumbnail_url") @db.VarChar(500)
  fileSize    Int?           @map("file_size") // 文件大小（字节）
  duration    Int?           // 视频时长（秒）
  tags        Json?          // 标签列表
  description String?        @db.VarChar(500)
  usageCount  Int            @default(0) @map("usage_count") // 使用次数
  uploadedBy  Int?           @map("uploaded_by")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  uploader    User?          @relation("MaterialUploader", fields: [uploadedBy], references: [id])

  @@index([type], name: "idx_material_type")
  @@index([category], name: "idx_material_category")
  @@map("materials")
}

enum MaterialType {
  video       // 视频
  image       // 图片
  audio       // 音频
  document    // 文档
  template    // 模板
}

// 话术模板库
model ScriptTemplate {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  category    String   @db.VarChar(50) // 分类：开场白、产品介绍、异议处理、成交话术等
  scenario    String?  @db.VarChar(100) // 适用场景
  content     String   @db.Text
  tags        Json?    // 标签
  usageCount  Int      @default(0) @map("usage_count")
  rating      Decimal? @db.Decimal(3, 2) // 平均评分
  createdBy   Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  creator     User?    @relation("ScriptCreator", fields: [createdBy], references: [id])

  @@index([category], name: "idx_script_category")
  @@map("script_templates")
}

// 自动化规则表
model AutomationRule {
  id          Int               @id @default(autoincrement())
  name        String            @db.VarChar(100)
  description String?           @db.VarChar(500)
  triggerType TriggerType       @map("trigger_type")
  triggerConfig Json            @map("trigger_config") // 触发条件配置
  actionType  ActionType        @map("action_type")
  actionConfig Json             @map("action_config") // 执行动作配置
  isEnabled   Boolean           @default(true) @map("is_enabled")
  priority    Int               @default(0) // 优先级
  executionCount Int            @default(0) @map("execution_count") // 执行次数
  lastExecutedAt DateTime?      @map("last_executed_at")
  createdBy   Int?              @map("created_by")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  creator     User?             @relation("AutomationCreator", fields: [createdBy], references: [id])
  logs        AutomationLog[]

  @@map("automation_rules")
}

enum TriggerType {
  schedule    // 定时触发
  event       // 事件触发
  condition   // 条件触发
}

enum ActionType {
  notification    // 发送通知
  task_create     // 创建任务
  task_assign     // 分配任务
  report_generate // 生成报告
  data_sync       // 数据同步
  alert           // 告警
}

// 自动化执行日志
model AutomationLog {
  id          Int      @id @default(autoincrement())
  ruleId      Int      @map("rule_id")
  status      AutomationLogStatus @default(success)
  inputData   Json?    @map("input_data")
  outputData  Json?    @map("output_data")
  errorMessage String? @map("error_message") @db.Text
  executedAt  DateTime @default(now()) @map("executed_at")

  rule        AutomationRule @relation(fields: [ruleId], references: [id])

  @@index([ruleId], name: "idx_automation_log_rule")
  @@map("automation_logs")
}

enum AutomationLogStatus {
  success
  failed
  skipped
}

// 通知表
model Notification {
  id          Int              @id @default(autoincrement())
  userId      Int              @map("user_id")
  type        NotificationType
  title       String           @db.VarChar(200)
  content     String           @db.Text
  relatedType String?          @map("related_type") @db.VarChar(50) // 关联对象类型
  relatedId   Int?             @map("related_id") // 关联对象ID
  isRead      Boolean          @default(false) @map("is_read")
  readAt      DateTime?        @map("read_at")
  createdAt   DateTime         @default(now()) @map("created_at")

  user        User             @relation("NotificationReceiver", fields: [userId], references: [id])

  @@index([userId, isRead], name: "idx_notification_user_read")
  @@index([createdAt], name: "idx_notification_created")
  @@map("notifications")
}

enum NotificationType {
  system       // 系统通知
  task         // 任务通知
  lead         // 线索提醒
  payment      // 回款提醒
  report       // 报告推送
  warning      // 预警通知
  announcement // 公告通知
}
